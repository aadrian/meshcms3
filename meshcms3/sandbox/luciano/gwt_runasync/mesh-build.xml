<?xml version="1.0" encoding="utf-8" ?>
<project name="MeshCMS-Ant-Tasks" default="" basedir=".">
  <path id="mesh-build-classpath">
  <fileset dir="lib/build" includes="**/*.jar"/>
  <fileset dir="lib/run" includes="**/*.jar"/>
  <path location="lib/gwt/gwt-dev.jar"/>
  <path location="lib/gwt/gwt-user.jar"/>
  </path>

  <path id="mesh-run-classpath">
  <pathelement path="build/web/WEB-INF/classes"/>
  <fileset dir="build/web/WEB-INF/lib" includes="**/*.jar"/>
  <path location="lib/gwt/gwt-servlet.jar"/>
  </path>

  <target name="mesh-clean" description="Delete generated files">
    <delete dir="build" quiet="true"/>
    <delete dir="dist" quiet="true"/>
    <delete includeemptydirs="true">
      <fileset dir="src/generated" includes="**/*"/>
    </delete>
  </target>

  <target name="mesh-generate" description="Perform code generation">
    <taskdef resource="dk/contix/gwt/apt/ant-apt.xml"
             classpathref="mesh-build-classpath"/>
    <gwtgenerate srcdir="src/java" classpathref="mesh-build-classpath"
                 serviceFactory="com.cromoteca.meshcms.client.core.ServiceFactory"
                 gendir="src/generated" prefix=""/>

    <taskdef name="gwti18n" classpathref="mesh-build-classpath"
             classname="com.cromoteca.ant.gwt.GWTI18NTask"/>
    <gwti18n gendir="src/generated" filetype="Constants">
      <fileset dir="src/java">
        <include name="com/cromoteca/meshcms/client/i18n/Constants.properties"/>
      </fileset>
    </gwti18n>
    <gwti18n gendir="src/generated" filetype="ConstantsWithLookup">
      <fileset dir="src/java">
        <include name="com/cromoteca/meshcms/client/i18n/LookupConstants.properties"/>
      </fileset>
    </gwti18n>
    <gwti18n gendir="src/generated" filetype="Messages">
      <fileset dir="src/java">
        <include name="com/cromoteca/meshcms/client/i18n/Messages.properties"/>
      </fileset>
    </gwti18n>

    <taskdef name="gwtclientbundle" classpathref="mesh-build-classpath"
             classname="com.cromoteca.ant.gwt.GWTClientBundleTask"/>
    <gwtclientbundle gendir="src/generated">
      <fileset dir="src/java">
        <include name="com/cromoteca/meshcms/client/icons/*.png"/>
      </fileset>
    </gwtclientbundle>
  </target>

  <target name="mesh-javac" description="Compile java source">
    <mkdir dir="build/web/WEB-INF/classes"/>
    <javac includes="**" encoding="utf-8" destdir="build/web/WEB-INF/classes"
           source="1.5" target="1.5" nowarn="true"
           debug="true" debuglevel="lines,vars,source">
      <classpath refid="mesh-build-classpath"/>
      <src path="src/java"/>
      <src path="src/generated"/>
    </javac>
    <copy todir="build/web/WEB-INF/classes">
      <fileset dir="src/java" excludes="**/*.java"/>
      <fileset dir="src/generated" excludes="**/*.java"/>
    </copy>
  </target>

  <target name="mesh-gwtc" description="GWT compile to JavaScript">
    <java failonerror="true" fork="true" classname="com.google.gwt.dev.Compiler">
      <classpath>
        <pathelement location="src/java"/>
        <pathelement location="src/generated"/>
        <path refid="mesh-build-classpath"/>
      </classpath>
      <jvmarg value="-Xss16M"/>
      <jvmarg value="-Xmx256M"/>
      <jvmarg value="-Dfile.encoding=utf-8"/>
      <arg value="-XdisableClassMetadata"/>
      <arg value="-XdisableCastChecking"/>
      <arg value="-localWorkers"/>
      <arg value="4"/>
      <!--
      <arg value="-style"/>
      <arg value="DETAILED"/>
      <arg value="-compileReport"/>
      -->
      <arg value="-war"/>
      <arg value="build/web"/>
      <arg value="com.cromoteca.meshcms.MeshCMS"/>
    </java>

    <copy todir="build/web/meshcms">
      <fileset dir="webapp/meshcms"/>
    </copy>
  </target>

  <target name="mesh-jar" description="Create JAR file">
    <mkdir dir="dist"/>
    <jar jarfile="dist/meshcms.jar"
         basedir="build/web/WEB-INF/classes"/>
  </target>

  <target name="mesh-war" description="Create WAR file">
    <war destfile="dist/meshcms.war">
      <fileset dir="build/web">
        <exclude name="WEB-INF/classes/**"/>
      </fileset>
      <lib dir="dist">
        <include name="meshcms.jar"/>
      </lib>
    </war>
  </target>

  <target name="mesh-copyapp" description="Copy webapp files">
    <copy todir="build/web">
      <fileset dir="webapp"/>
    </copy>
    <copy todir="build/web/WEB-INF/lib">
      <fileset dir="lib/run"/>
      <fileset dir="lib/gwt" includes="gwt-servlet.jar"/>
    </copy>
    <copy todir="build/web/meshcms/resources/lib/icons">
      <fileset dir="src/java/com/cromoteca/meshcms/client/icons"/>
    </copy>
    <copy todir="build/web/WEB-INF/classes/META-INF">
      <fileset dir="conf"/>
    </copy>
    <copy todir="build/web/cms/server/editors" failonerror="false">
      <fileset dir="lib/editors"/>
    </copy>
  </target>

  <target name="mesh-devmode" description="Run development mode">
    <java failonerror="true" fork="true" classname="com.google.gwt.dev.DevMode">
      <classpath>
        <pathelement location="src/java"/>
        <pathelement location="src/generated"/>
        <path refid="mesh-run-classpath"/>
        <pathelement location="lib/gwt/gwt-dev.jar"/>
        <pathelement location="lib/gwt/gwt-user.jar"/>
      </classpath>
      <jvmarg value="-Xss16M"/>
      <jvmarg value="-Xmx256M"/>
      <jvmarg value="-Dfile.encoding=utf-8"/>
      <arg value="-port"/>
      <arg value="8887"/>
      <arg value="-codeServerPort"/>
      <arg value="9997"/>
      <arg value="-war"/>
      <arg value="build/web"/>
      <arg value="-startupUrl"/>
      <arg value="/meshcms/resources/host.jsp?mode=file_manager"/>
      <arg value="com.cromoteca.meshcms.MeshCMS"/>
    </java>
  </target>

  <target name="mesh-jalopy" description="Format Java files with Jalopy">
    <taskdef name="jalopy" classpathref="mesh-build-classpath"
             classname="de.hunsicker.jalopy.plugin.ant.AntPlugin"/>

    <jalopy fileformat="unix" history="none"
            convention="${basedir}/lib/build/jalopy-cromoteca.xml">
      <fileset dir="src/java" includes="**/*.java"/>
      <fileset dir="src/generated" includes="**/*.java"/>
    </jalopy>
  </target>
</project>
